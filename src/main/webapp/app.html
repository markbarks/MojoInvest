<!doctype html>
<html>
<head>
    <title>App</title>
    <meta charset="utf-8">
    <link href="css/mojo.css" rel="stylesheet" type="text/css"/>
    <link href="css/smoothness/jquery-ui-1.8.20.custom.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<div id="back">

    <div id="head">
        <div class="main">
            <a class="left" href=""><img src="../images/mojo_logo.png" alt="Mojoinvest"/></a>
            <ul id="menu">
                <li><a href="">Home</a></li>
                <li><a href="">Backtest</a></li>
                <li><a href="">Tools</a></li>
            </ul>
        </div>
        <div class="clear"></div>
    </div>

    <div id="loadingDiv">Loading</div>

    <div id="content" class="main">
    </div>

    <div id="footer">
        <div class="main">
            <ul class="left">
                <li><a href="About/index.html">About</a></li>
                <li><a href="Help/index.html">Help</a></li>
                <li><a href="Terms/index.html">Terms</a></li>
            </ul>
                <span class="right">
                    &copy; 2012 Mojoinvest Ltd.
                </span>

            <div class="clear"></div>
        </div>
    </div>
</div>

<script src="lib/jquery-1.7.2.min.js"></script>
<script src="lib/jquery-ui-1.8.20.custom.min.js"></script>
<script src="lib/underscore.js"></script>
<script src="lib/backbone.js"></script>
<script src="lib/ICanHaz.js"></script>
<script src="http://www.google.com/jsapi"></script>
<script src="lib/dygraph-combined.js"></script>

<script>

window.App = {
    //Main application namespace
};

//JQuery set up stuff - where should this live?
(function ($) {
    $.fn.toggleDisabled = function () {
        return this.each(function () {
            this.disabled = !this.disabled;
        });
    };
})(jQuery);
$.datepicker.setDefaults({
    dateFormat:"yy-mm-dd"
});
$('#loadingDiv')
        .hide()// hide it initially
        .ajaxStart(function () {
//            http://malsup.com/jquery/block/#demos
            $(this).show();
        })
        .ajaxStop(function () {
            $(this).hide();
        });


tpl = {

    // Recursively pre-load all the templates for the app.
    // This implementation should be changed in a production environment. All the template files should be
    // concatenated in a single file.
    loadTemplates:function (names, callback) {

        var loadTemplate = function (index) {
            var name = names[index];
            console.log('Loading template: ' + name);
            $.get('mustache/' + name + '.mustache', function (data) {
                ich.addTemplate(name, data);
                index++;
                if (index < names.length) {
                    loadTemplate(index);
                } else {
                    callback();
                }
            }, "html");
        };

        loadTemplate(0);
    },

    // Get template by name from hash of preloaded templates
    get:function (name) {
        return this.templates[name];
    }

};

App.Params = Backbone.Model.extend({});
App.Results = Backbone.Model.extend({});
App.AppModel = Backbone.Model.extend({});


App.ParamsView = Backbone.View.extend({

    initialize:function () {
        this.model.bind("change", this.render, this);
        this.model.bind("destroy", this.close, this);
    },

    render:function () {
        $(this.el).html(ich.params(this.model.toJSON({})));
        this.$("#fromDate").datepicker();
        this.$("#toDate").datepicker();
        this.$("input[name=relativeStrengthStyle][value=" + this.model.get("relativeStrengthStyle") + "]")
                .attr('checked', 'checked');

        this.$("#ma1").val(this.model.get("ma1"));
        this.$("#ma2").val(this.model.get("ma2"));
        this.$("#roc").val(this.model.get("roc"));
        this.$("#alpha").val(this.model.get("alpha"));

        //TODO: Consolidate this logic with the rsRadioClicked logic below
        switch ($('input[name=relativeStrengthStyle]:checked', '#relativeStrength').val()) {
            case "MA" :
                this.$('#ma1').attr('disabled', false);
                this.$('#ma2').attr('disabled', false);
                this.$('#roc').attr('disabled', true);
                this.$('#alpha').attr('disabled', true);
                break;
            case "ROC" :
                this.$('#ma1').attr('disabled', true);
                this.$('#ma2').attr('disabled', true);
                this.$('#roc').attr('disabled', false);
                this.$('#alpha').attr('disabled', true);
                break;
            case "ALPHA" :
                this.$('#ma1').attr('disabled', true);
                this.$('#ma2').attr('disabled', true);
                this.$('#roc').attr('disabled', true);
                this.$('#alpha').attr('disabled', false);
                break;
        }


        this.$("#stdDev").val(this.model.get("stdDev"));
        this.$("#riskAdjusted").attr('checked', this.model.get("riskAdjusted"));
        this.$("#stdDev").attr('disabled', !this.model.get("riskAdjusted"));
        this.$("#tradeEquityCurve").attr('checked', this.model.get("tradeEquityCurve"));
        this.$("#equityCurveWindow").attr('disabled', !this.model.get("tradeEquityCurve"));
        this.$("#useSafeAsset").attr('checked', this.model.get("useSafeAsset"));
        this.$("#safeAsset").attr('disabled', !this.model.get("useSafeAsset"));
        //TODO: Need to disable and uncheck useSafeAsset when trade equity curve is unchecked
        return this;
    },

    events:{
        "click input[name='relativeStrengthStyle']:radio":"rsRadioClicked",
        "click #mybutt":"runBacktest"
    },

    rsRadioClicked:function (event) {
        // find out which radio button was clicked and
        // disable/enable appropriate input elements
        switch (event.currentTarget.id) {
            case "maRatioRadio" :
                this.$('#ma1').attr('disabled', false);
                this.$('#ma2').attr('disabled', false);
                this.$('#roc').attr('disabled', true);
                this.$('#alpha').attr('disabled', true);
                break;
            case "rocRadio" :
                this.$('#ma1').attr('disabled', true);
                this.$('#ma2').attr('disabled', true);
                this.$('#roc').attr('disabled', false);
                this.$('#alpha').attr('disabled', true);
                break;
            case "alphaRadio" :
                this.$('#ma1').attr('disabled', true);
                this.$('#ma2').attr('disabled', true);
                this.$('#roc').attr('disabled', true);
                this.$('#alpha').attr('disabled', false);
                break;
        }

    },

    runBacktest:function (event) {

        this.model.set({
            "initialInvestment":$('#initialInvestment').val(),
            "transactionCost":$('#transactionCost').val(),
            "portfolioSize":$('#portfolioSize').val(),
            "relativeStrengthStyle":$('input[name=relativeStrengthStyle]:checked', '#relativeStrength').val(),
            "ma1":$('#ma1').val(),
            "ma2":$('#ma2').val(),
            "roc":$('#roc').val(),
            "alpha":$('#alpha').val(),
            "rebalanceFrequency":$('#rebalanceFrequency').val(),
            "castOff":$('#castOff').val(),
            "riskAdjusted":$('#riskAdjusted').is(':checked'),
            "stdDev":$('#stdDev').val(),
            "tradeEquityCurve":$('#tradeEquityCurve').is(':checked'),
            "equityCurveWindow":$('#equityCurveWindow').val(),
            "useSafeAsset":$('#useSafeAsset').is(':checked'),
            "safeAsset":$('#safeAsset').val(),
            "fromDate":$('#fromDate').val(),
            "toDate":$('#toDate').val(),
            "creationDate":$('#fromDate').val()
        });
        $.ajax({
            type:'GET',
            url:"http://localhost:8000/response.json",
            data:JSON.stringify(this.model),
            success:this.success,
            error:this.error,
            contentType:"application/json;charset=utf-8",
            dataType:'json'
        });

        console.log(JSON.stringify(this.model));
        return false;
    },

    success:function (data) {
        App.results = new App.Results(data);
        App.router.navigate('results', true);
    },

    error:function (jqXHR, textStatus, errorThrown) {
        console.log(jqXHR, textStatus, errorThrown);
        alert(jqXHR + " " + textStatus + " " + errorThrown);
//        App.router.navigate('results', true);
    }

});

App.UniverseView = Backbone.View.extend({
    initialize:function () {
        this.model.bind("change:universe", this.render, this);
    },

    render:function () {
        $(this.el).html(ich.universe(this.model.toJSON({})));
//        this.$('universe-table').fixedHeaderTable({ footer:false, cloneHeadToFoot:false, fixedColumn:false });
        return this;
    }

});

App.FundsView = Backbone.View.extend({
    initialize:function () {
    },

    render:function () {
        //Todo: figure out why I have to wrap the funds in another object,
        // even though when passing model they should be referenceable as #funds
        $(this.el).html(ich.funds(App));

        var universe = App.params.get("universe");
        this.$("input[name='includeFundCheck']:checkbox").each(function (index) {
            if ($.inArray($(this).val(), universe) != -1) {
                $(this).attr("checked", true);
            }
        });

        return this;
    },

    events:{
        "click input[name='includeFundCheck']:checkbox":"includeFundClicked"
    },

    includeFundClicked:function (event) {
        var fund = event.currentTarget.value;
        var universe = App.params.get("universe");
        var index = $.inArray(fund, universe);
        if (index == -1) {
            universe.push(fund);
        } else {
            universe.splice(index, 1);
        }
        //Trigger a change event on the universe view.
        // Not automatic because params.universe is not a collection
        //Not sure why model.change() is not working-
        // http://stackoverflow.com/questions/8280790/backbone-js-model-not-firing-events
        App.params.trigger('change:universe');
    }
});

App.ChartView = Backbone.View.extend({

    render:function () {
        $(this.el).html(ich.results());
        console.log("ChartView render");
        google.load('visualization', '1', {'callback':this.drawVisualization,
            'packages':['linechart']});
        return this;
    },

    drawVisualization:function () {
        var data = new google.visualization.DataTable(App.results.get('dataTable'));
        new Dygraph.GVizChart(this.$('#chart').get(0)).draw(data,
                {
//                    customBars: true,
//                    title: 'Daily Temperatures in New York vs. San Francisco',
//                    ylabel: '(F)',
//                    legend: 'always',
//                    labelsDivStyles: { 'textAlign': 'right' },
                    showRangeSelector:true
                });
    }


});


Backbone.View.prototype.close = function () {
    console.log('Closing view ' + this);
    if (this.beforeClose) {
        this.beforeClose();
    }
    this.remove();
    this.unbind();
};

var AppRouter = Backbone.Router.extend({

    initialize:function () {
        console.log("initializing AppRouter");
    },

    routes:{
        "":"params",
        "results":"results"
    },

    params:function () {
        console.log("Showing params");
        var views = [new App.ParamsView({model:App.params}),
            new App.UniverseView({model:App.params}),
            new App.FundsView()];
        App.router.showViews("#content", views)
    },

    results:function () {
        console.log("Showing results");
        var views = [new App.ChartView({model:App.results})];
        App.router.showViews("#content", views)
    },

    showViews:function (selector, views) {
        if (this.currentViews) {
            for (var i = 0; i < this.currentViews.length; i++) {
                this.currentViews[i].close();
            }
        }
        for (var j = 0; j < views.length; j++) {
            $(selector).append(views[j].render().el);
        }
        this.currentViews = views;
    }

});

</script>


<script>

    console.log("bootstrapping models");

    App.params = new App.Params({"fromDate":"2000-01-01", "toDate":"2012-03-01", "creationDate":"1990-01-01", "initialInvestment":10000.0, "transactionCost":10.0, "portfolioSize":1, "rebalanceFrequency":1, "ma1":12, "ma2":26, "roc":26, "alpha":100, "castOff":8, "riskAdjusted":true, "stdDev":26, "tradeEquityCurve":true, "equityCurveWindow":52, "relativeStrengthStyle":"MA", "useSafeAsset":false, "safeAsset":"IGLT", "universe":["EWM", "EWW", "EWL", "EWU", "EWS", "EWH", "EWA", "EWJ", "EWG", "EWD", "EWK", "EWQ", "EWC", "EWN", "EWP", "EWI", "EWO"]});
    App.funds = [
        {"symbol":"EWA", "name":"iShares MSCI Australia Index", "category":"Pacific Stock", "provider":"iShares", "active":true, "country":"US", "index":"", "overview":"", "inceptionDate":"1996-04-01"},
        {"symbol":"EWC", "name":"iShares MSCI Canada Index", "category":"Foreign Stock", "provider":"iShares", "active":true, "country":"US", "index":"", "overview":"", "inceptionDate":"1996-04-01"},
        {"symbol":"EWD", "name":"iShares MSCI Sweden Index", "category":"Europe Stock", "provider":"iShares", "active":true, "country":"US", "index":"", "overview":"", "inceptionDate":"1996-04-01"},
        {"symbol":"EWG", "name":"iShares MSCI Germany Index", "category":"Europe Stock", "provider":"iShares", "active":true, "country":"US", "index":"", "overview":"", "inceptionDate":"1996-04-01"},
        {"symbol":"EWH", "name":"iShares MSCI Hong Kong Index", "category":"Pacific Stock", "provider":"iShares", "active":true, "country":"US", "index":"", "overview":"", "inceptionDate":"1996-04-01"},
        {"symbol":"EWI", "name":"iShares MSCI Italy Index", "category":"Europe Stock", "provider":"iShares", "active":true, "country":"US", "index":"", "overview":"", "inceptionDate":"1996-04-01"},
        {"symbol":"EWJ", "name":"iShares MSCI Japan Index", "category":"Pacific Stock", "provider":"iShares", "active":true, "country":"US", "index":"", "overview":"", "inceptionDate":"1996-04-01"},
        {"symbol":"EWK", "name":"iShares MSCI Belgium Investable Mkt Idx", "category":"Europe Stock", "provider":"iShares", "active":true, "country":"US", "index":"", "overview":"", "inceptionDate":"1996-04-01"},
        {"symbol":"EWL", "name":"iShares MSCI Switzerland Index", "category":"Europe Stock", "provider":"iShares", "active":true, "country":"US", "index":"", "overview":"", "inceptionDate":"1996-04-01"},
        {"symbol":"EWM", "name":"iShares MSCI Malaysia Index", "category":"Pacific Stock", "provider":"iShares", "active":true, "country":"US", "index":"", "overview":"", "inceptionDate":"1996-04-01"},
        {"symbol":"EWN", "name":"iShares MSCI Netherlands Invstbl Mkt Idx", "category":"Europe Stock", "provider":"iShares", "active":true, "country":"US", "index":"", "overview":"", "inceptionDate":"1996-04-01"},
        {"symbol":"EWO", "name":"iShares MSCI Austria Investable Mkt Idx", "category":"Europe Stock", "provider":"iShares", "active":true, "country":"US", "index":"", "overview":"", "inceptionDate":"1996-04-01"},
        {"symbol":"EWP", "name":"iShares MSCI Spain Index", "category":"Europe Stock", "provider":"iShares", "active":true, "country":"US", "index":"", "overview":"", "inceptionDate":"1996-04-01"},
        {"symbol":"EWQ", "name":"iShares MSCI France Index", "category":"Europe Stock", "provider":"iShares", "active":true, "country":"US", "index":"", "overview":"", "inceptionDate":"1996-04-01"},
        {"symbol":"EWS", "name":"iShares MSCI Singapore Index", "category":"Pacific Stock", "provider":"iShares", "active":true, "country":"US", "index":"", "overview":"", "inceptionDate":"1996-04-01"},
        {"symbol":"EWU", "name":"iShares MSCI United Kingdom Index", "category":"Europe Stock", "provider":"iShares", "active":true, "country":"US", "index":"", "overview":"", "inceptionDate":"1996-04-01"},
        {"symbol":"EWW", "name":"iShares MSCI Mexico Investable Mkt Idx", "category":"Diversified Emerging Markets", "provider":"iShares", "active":true, "country":"US", "index":"", "overview":"", "inceptionDate":"1996-04-01"}
    ];

    //Load templates is async because of http requests
    tpl.loadTemplates(['params', 'funds', 'universe', 'results'], function () {
        App.router = new AppRouter();
        Backbone.history.start();
    });

</script>

</body>

</html>