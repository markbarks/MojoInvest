<!doctype html>
<html>
<head>
    <title>Chart</title>
    <meta charset="utf-8">
</head>
<body>
<div id="content"></div>

<link href="css/mojo.css" rel="stylesheet" type="text/css"/>
<script src="lib/jquery-1.7.2.min.js"></script>
<script src="lib/underscore.js"></script>
<script src="lib/backbone.js"></script>
<script src="lib/ICanHaz.js"></script>
<script src="http://www.google.com/jsapi"></script>
<script src="lib/dygraph-combined.js"></script>

<script>
    window.App = {
        //Main application namespace
    };

    App.tpl = {

        loadTemplates:function (names, callback) {
            var loadTemplate = function (index) {
                var name = names[index];
                console.log('Loading template: ' + name);
                $.ajax({type:'GET',
                    url:'mustache/' + name + '.mustache',
                    success:function (data) {
                        ich.addTemplate(name, data);
                        index++;
                        if (index < names.length) {
                            loadTemplate(index);
                        } else {
                            console.log("Running callback " + callback);
                            callback();
                        }
                    },
                    error:function (jqXHR, textStatus, errorThrown) {
                        console.log(jqXHR, textStatus, errorThrown);
                        alert(jqXHR + " " + textStatus + " " + errorThrown);
                    },
                    dataType:'html'

                })
            };
            loadTemplate(0);
        },

        // Get template by name from hash of preloaded templates
        get:function (name) {
            return this.templates[name];
        }

    };

    ChartView = Backbone.View.extend({
        render:function () {
            $(this.el).html(ich.results());
            console.log("ChartView render");
            google.load('visualization', '1', {'callback':this.drawVisualization,
                'packages':['linechart']});
            return this;
        },

        drawVisualization:function () {
            var data = new google.visualization.DataTable();

            data.addColumn('date', 'Date');
            data.addColumn('number', 'Sold Pencils');
            data.addColumn('string', 'title1');
            data.addColumn('string', 'text1');
            data.addColumn('number', 'Sold Pens');
            data.addColumn('string', 'title2');
            data.addColumn('string', 'text2');
            data.addRows([
                [new Date(2008, 1, 1), 30000, undefined, undefined, 40645, undefined, undefined],
                [new Date(2008, 2, 1), 14045, undefined, undefined, 20374, undefined, undefined],
                [new Date(2008, 2, 3), 27000, "Hello", "Jello", undefined, undefined, undefined],
                [new Date(2008, 3, 1), 75284, undefined, undefined, 14334, 'Out of Stock', 'Ran out of stock on pens at 4pm'],
                [new Date(2008, 4, 1), 41476, 'Bought Pens', 'Bought 200k pens', 66467, undefined, undefined],
                [new Date(2008, 5, 1), 33322, undefined, undefined, 39463, undefined, undefined]
            ]);


            var graph = new Dygraph.GVizChart(this.$('#chart').get(0)).draw(data,
                    {
                        showRangeSelector:true,
                        displayAnnotations:true,
                        connectSeparatedPoints:true,
                        fillGraph:true
                    });
        }
    });

    var AppRouter = Backbone.Router.extend({
        routes:{
            "":"chart"
        },
        chart:function () {
            console.log("Routing to ChartView");
            $("#content").append(new ChartView().render().el);
        }
    });

    App.tpl.loadTemplates(['results'], function () {
        App.router = new AppRouter();
        Backbone.history.start();
    });

</script>

</body>
</html>